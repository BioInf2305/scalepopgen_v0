## scalepopgen: PCA and ADMIXTURE

This module combines Admixture analysis and two different Principal Component Analyses. The first PCA can be done with the function SmartPCA of the [EIGENSOFT](https://github.com/chrchang/eigensoft/tree/master/POPGEN) software and performed with the argument: ``` run_smartpca = true```. The second one is done by using the function snpgdsPCA inside the R package [SNPRelate](https://code.bioconductor.org/browse/SNPRelate/RELEASE_3_17/) and can be invoked with the argument: ``` run_gds_pca = true```. Analysis with the program [Admixture](https://dalexander.github.io/admixture/) are carried out with the argument ``` admixture = true```. 

The above-mentioned analyses consist of the following steps:

**1.** converting vcf to bed file format using Plink 
**2.** merging converted bed files (separated by chromosomes) into one with Plink
**3.** removing listed individuals and updating the family IDs with Plink 
**4.** applying Linkage Disequilibrium based filtering of bed files with Plink  
**5.** running both types of PCA analyses with plotting the results  
**6.** running admixture from the starting and ending k-value selected by the user  
**7.** performing block cross-validation of k-values  
**8.** selecting the optimal number of clusters (K) regarding the lowest cross validation error and plotting the results

> **Note:** If your input files are already in Plink format, it will skip the first step.
## Description of the parameters:
```ld_filt```: an option to use LD-based filtering according to parameters specified below (default: true), meaning to include or skip step 4;
```ld_window_size```: a window size (default: 50) in variant count or kilobases (step 4);
```step_size```: number of variants (default: 10) to shift the window at the end of each step (step 4);
```r2_value```: squared correlation threshold (default: 0.1); at each step, only pairs of variants with r2 greater than the threshold are recognized (step 4);
```structure_remove_indi```: the name of a file in which you specified samples you do not want to use for admixture and PCA (step 5);
```smartpca_param```: the name of a parameter file that will be used for the SmartPCA (step 5);
```pop_color_file```: a name of a tab-delimited text file with specified R colors for each population; the Family IDs are in the first column and R-color code in the second (step 5);
```starting_k_value```: starting number of clusters (step 6);
```ending_k_value```: maximal number of clusters (step 6);
```method```: type of the method (default: "block") to select the optimal number of clusters (step 7), option "-m" in program Admixture - alternative to "block" relaxation algorithm is "EM" algorithm;
```cross_validation```: the number of folds (default: 10) for cross-validation (step 7);
```termination_criteria```: the lowest limit of the log-likelihood change (default: 0.0001) between iterations to stop the process (step 7), option "-C" in program Admixture - based on integer or floating number this argument is interpreted as a delta or an iteration count;
```best_kval_method```: the procedure (default: "global") for choosing the optimal K value (step 8)
```pop_labes```: the name of the text file; you use this option, if you want to change population IDs for the admixture graph (step 8)
## Description of the output files generated by this sub-workflow:
If the pipeline has completed successfully, all these output files will be stored in **${output directory}/genetic_structure/**.

You will find the PCA results in two sub-folder **./smartpca** and **./gds_pca**.
Results of SmartPCA:
**\*_ld_filtered.snp** , **\*_ld_filtered.ind**, **\*_ld_filtered.eigenstratgeno** : input files used for the analysis
**\*_ld_filtered.evec** : a table of a positions for each individual along  with eigenvectors in the header row
**\*_ld_filtered.eval** : a column of ordered eigenvalues corresponding to the eigenvectors
Results of snpgdsPCA:
**\*_ld_filtered.varprop** : proportion of variance for each principal component
**\*_ld_filtered.jpeg** : graph of first two eigenvalues
**\*_ld_filtered.eigenvect** : a table of eigenvectors for each individual

You will find the admixture results in a sub-folder **./admixture**:
**\*_ld_filtered.\${K}\.P** : table of the allele frequencies inferred for each SNP in each population 
**\*_ld_filtered.\${K}\.Q** : table of inferred individual ancestry proportions from the K ancestral populations, with one row per individual
**\*.\${K}\.Q.png** : the admixture plot of the optimal K value
**\best_k_\${K}\.png** : the plot of CV errors for determinating optimal K value
**pongInput.map** : the input file for the program Pong.

## Validation of the sub-workflow:
### 1. Required input data files
For workflow validation, we have downloaded publicly available samples with whole genome sequences from NCBI database. We included domestic goats (*Capra hircus*) represented by various breeds from Morocco and Switzerland (geo_map). In addition to them, we also included some wild *Capra* members that are: Alpine ibex (*C. ibex*), Iberian ibex (*C. pyrenaica*) and Siberian ibex (*C. sibirica*). Since we need an outgroup when performing some analyses, we also added Urial sheep (*Ovis vignei*). We will use variants from chromosome 28 and 29 of, all together, 39 animals.

The input data should be in the **VCF** or **PLINK binary** format files. 

All VCF files need to be splitted by the chromosomes and indexed with tabix. You will have to prepare csv list of those files. Each row is corresponding to one chromosome and each row has three different information separated by the comma. Like in example below, the first information in each row is chromosome name, next is path/to/the/file.vcf.gz and the last is path/to/the/file.vcf.gz.tbi.  
```
Chr28,/data/trial/NC_030835.1.vcf.gz,/data/trial/NC_030835.1.vcf.gz.tbi
Chr29,/data/trial/NC_030836.1.vcf.gz,/data/trial/NC_030836.1.vcf.gz.tbi
```
In addition to the VCF input format, it is also necessary to prepare a sample map file of individuals and populations. Sample map has two tab-delimited columns: in the first column are individual IDs and in the second are population IDs as demonstrated on the example below.
```
AfrGoat10 AfricaGoat
AfrGoat1 AfricaGoat
AfrGoat2 AfricaGoat
AfrGoat3 AfricaGoat
AfrGoat4 AfricaGoat
AfrGoat5 AfricaGoat
AfrGoat6 AfricaGoat
AfrGoat7 AfricaGoat
AfrGoat8 AfricaGoat
AfrGoat9 AfricaGoat
AlpIbex1 AlpineIbex
AlpIbex2 AlpineIbex
AlpIbex3 AlpineIbex
AlpIbex4 AlpineIbex
AlpIbex5 AlpineIbex
AlpIbex6 AlpineIbex
AlpIbex7 AlpineIbex
AlpIbex8 AlpineIbex
AlpIbex9 AlpineIbex
IbrIbex1 IberianIbex
IbrIbex2 IberianIbex
IbrIbex3 IberianIbex
IbrIbex4 IberianIbex
SibIbex1 SiberianIbex
SibIbex2 SiberianIbex
SwiGoat10 SwissGoat
SwiGoat11 SwissGoat
SwiGoat12 SwissGoat
SwiGoat1 SwissGoat
SwiGoat2 SwissGoat
SwiGoat3 SwissGoat
SwiGoat4 SwissGoat
SwiGoat5 SwissGoat
SwiGoat6 SwissGoat
SwiGoat7 SwissGoat
SwiGoat8 SwissGoat
SwiGoat9 SwissGoat
UriShep1 Urial
UriShep2 Urial
```
For the Plink binary input, you need to specified the path to the BED/BIM/FAM files in the section of general parameters:
```input= "path/to/the/files/*.{bed,bim,fam}"```
### 2. Optional input data files
This module allows you to remove samples, like the outgroup, that you want to exclude in given analyses (```structure_remove_indi```). You have to prepare a space/tab-delimited text file with family IDs in the first column and within-family IDs in the second column as stated by [PLINK](https://www.cog-genomics.org/plink/2.0/filter#sample) (option --remove):
```
Urial UriShep1
Urial UriShep2
```
If you want to provide your file with optional parameters for the program SmartPCA (```smartpca_param```). You can make one according to the [instructions of the EIGENSOFT software](https://github.com/chrchang/eigensoft/tree/master/POPGEN).

As well, you can specify the desired colors by population for the final PCA graphs (```pop_color_file```). You have to make a tab-delimited text file, where the population names are in the first column and specified R color codes in the second:

Additional you can also change population names (```pop_labels```), which will be considered only for plotting the results. You need to prepare a text file...to be continued... 

### 3. Setting the parameters
At the beginning of the parameter file ***/parameters/scale_popgen.config**, we have to specified some of the general things first. 
```input```: name of the .csv input file for the VCF format or names of the PLINK binary files
```outDir```: the name of the output folder
```prefix```: prefix of the output files
```sample_map```: the name of the file with individuals and populations as addition to VCF input
```fasta```: the name of the reference genome fasta file that will be used for converting from VCF to PLINK format 
 ```allow_extra_chrom```: set to true if the input contains chromosome name in the form of string
```max_chrom```: maximum number of chromosomes
```outgroup```: the population ID of the outgroup (optimal)
```cm_to_bp```: the number of base pairs that corresponds to one centimorgan (optimal)

After that, there are two parts dedicated to the PCA and ADMIXTURE analyses. 

**// general parameters**

    input                     = "/data/trial/input.csv"
    outDir                    = "${baseDir}/../PCA_Admix/"
    prefix                    = "PCA_Admix"
    sample_map                = "/data/trial/sample.map"
    fasta                     = "/data/trial/goat_ref.fasta"
    chrm_map                  = "none"
    allow_extra_chrom         = true 
    max_chrom                 = 2
    outgroup                  = "Urial"
    cm_to_bp                   = 0

**//ld filter for PCA and ADMIXTURE analysis**

    run_smartpca             = true
    run_gds_pca              = true
    ld_filt                  = true
    ld_window_size           = 50
    step_size                = 10
    r2_value                 = 0.01

    structure_remove_indi    = "remov_outgroup.txt"
    smartpca_param           = "none"
    pop_color_file           = "none"

**//admixture analysis parameters**

    admixture                 = true
    starting_k_value          = 2
    ending_k_value            = 10
    method                    = "block"
    cross_validation          = 5
    termination_criteria      = 0.0001
    best_kval_method          = "global"
    pop_labels                = "none"
## References
Please cite the following papers if you use this sub-workflow in your study:

[1] Alexander, D. H., Novembre, J., & Lange, K. (2009). Fast model-based estimation of ancestry in unrelated individuals. Genome research, 19(9), 1655â€“1664. https://doi.org/10.1101/gr.094052.109

[2] Patterson, N., Price, A. L., & Reich, D. (2006). Population structure and eigenanalysis. PLoS genetics, 2(12), e190. https://doi.org/10.1371/journal.pgen.0020190

[3] Price, A. L., Patterson, N. J., Plenge, R. M., Weinblatt, M. E., Shadick, N. A., & Reich, D. (2006). Principal components analysis corrects for stratification in genome-wide association studies. Nature genetics, 38(8), 904â€“909. https://doi.org/10.1038/ng1847

[4] Zheng, X., Levine, D., Shen, J., Gogarten, S. M., Laurie, C., & Weir, B. S. (2012). A high-performance computing toolset for relatedness and principal component analysis of SNP data. Bioinformatics (Oxford, England), 28(24), 3326â€“3328. https://doi.org/10.1093/bioinformatics/bts606

## License

MIT



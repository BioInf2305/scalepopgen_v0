## scalepopgen: Filter

Filtering data is the introductory step before conducting main analyses. The scalepopgen tool offers sample filtering, which can be carried out with the argument ```apply_indi_filters = true```, and SNP based filtering that can be launch with the argument ```apply_snp_filters = true```. The filtering process depends on the format of the input files. The processes of sample and site filtering will be done in [PLINK](https://www.cog-genomics.org/plink/2.0/), if the provided inputs are in program´s binaries. This is only partially true for the VCF inputs, where for the site filtering we implemented [VCFtools](https://vcftools.github.io/index.html), instead. 

For the sample filtering user has the following options:
 - removing samples according to the threshold of calculated kinship coefficient  
 - removing samples according to the amount of missing genotypes
 - removing user-defined samples

The site filtering options depend on the input format as mentioned before. For the VCF input all listed options are available, while in the case of PLINK input just the first four of them:
 - filtering based on minor allele frequency threshold
 - filtering according to the Hardy-Weinberg equilibrium exact test
 - filtering SNPs according to the amount of missing information 
 - removing user-defined SNPs
 - filtering SNPs based on min and max average depths
 - filtering SNPs according to the base quality limit

		!Here will be the workflow picture!
## Description of the parameters:
```king_cutoff```: samples with relationship coefficient greater than this will be removed;
```rem_indi```:  the name of text file containing individuals to be removed;
```mind```: samples with missing genotypes greater than the threshold selected here will be removed;
```indiv_summary```: if set to true it will calculate sample-based summary statistics from VCF files, after individual- and site-based filtering;
```remove_snps```: the name of text file containing names of SNPs that will be removed;
```maf```: SNPs with minor allele frequencies less than the threshold specified here will be removed;
```min_meanDP```: SNPs with average depth (across the samples) less than the threshold specified here will be removed (only for the VCF input);
```max_meanDP```: SNPs with average depth (across the samples) greater than the threshold specified here will be removed (only for the VCF input);
```hwe```: SNPs with HWE p-values of less than the threshold specified here will be removed;
```max_missing```: SNPs which proportion of missing genotypes will exceeded the threshold selected here will be removed;
```minQ```: SNPs with base quality less than specified here will be removed (only for the VCF input)
## Description of the output files generated by this sub-workflow:
The scheme of output files differs according to the input formats. Lets take a look of the output structure for the VCF input. If the pipeline has completed successfully, it will generate three different subfolders in the specified output folder. 

->**\${output directory}/plink/**:
---->**./indi_filtered/**: sample-based filtering
-------->**\*.king.cutoff.out.id**: list of related samples that will be excluded
-------->**\*.bim, \*bed, \*.fam**: filtered PLINK format files 
-------->**indi_kept.txt**: file with listed samples that will be kept after sample-based filtering

->**\${output directory}/vcftools/**:
---->**./indi_filtered/**: sample filtering with VCFtools based on list (indi_kept.txt) generated before
-------->**\*_filt_samples.vcf.gz**: sample filtered VCF files
-------->**\*_filt_samples.vcf.gz.tbi**:indexed VCF files
---->**./sites_filtered/**: site-based filtering
-------->**\*_filt_samples_filt_sites.vcf.gz**: sample and site filtered VCF files
-------->**\*_filt_samples_filt_sites.vcf.gz.tbi**:indexed VCF files

->**\${output directory}/summary_stats/indiv_stats/**:
---->**\*_depth_info.idepth**: mean depth of samlples for each chromosome
---->**\*_sample_summary.scount**: 
---->**genomewide_sample_stats.tsv**:


If your input is in PLINK format, the filtered files will be stored in a folder **\${output directory}/plink/**. Similar as with VCF, inside you will find a subfolder **./indi_filtered/**, in which is the same content as specified above. In addition, there is also a subfolder **./sites_filtered/**, where you will find final sample and site filtered PLINK binary files:
---->**\*_indi_kept_filt_sites.bed**
---->**\*_indi_kept_filt_sites.bim**
---->**\*_indi_kept_filt_sites.fam**

> **Note:** The output folders also contains the  **\*.log** files of the programs PLINK and VCFtools.


## Validation of the sub-workflow:
### 1. Required input data files
For workflow validation, we have downloaded publicly available samples with whole genome sequences from NCBI database. We included domestic goats (*Capra hircus*) represented by various breeds from Switzerland (geo_map). In addition to them, we also included Alpine ibex (*C. ibex*) and Bezoar wilg goat (*C. aegagrus*). Since we need an outgroup when performing some of the analyses, we also added Urial sheep (*Ovis vignei*). We will use variants from chromosome 28 and 29 of, all together, 85 animals.

The input data should be in the **VCF** or **PLINK binary** format files. 

All VCF files need to be splitted by the chromosomes and indexed with tabix. You will have to prepare csv list of those files, please check *test_input_vcf.csv*. Each row is corresponding to one chromosome and has three different information separated by the comma. Like in example below, the first information in each row is chromosome name, next is path/to/the/file.vcf.gz and the last is path/to/the/file.vcf.gz.tbi.  
```
chr28,https://data.cyverse.org/dav-anon/iplant/home/maulik88/28_filt_samples.vcf.gz,https://data.cyverse.org/dav-anon/iplant/home/maulik88/28_filt_samples.vcf.gz.tbi
chr29,https://data.cyverse.org/dav-anon/iplant/home/maulik88/29_filt_samples.vcf.gz,https://data.cyverse.org/dav-anon/iplant/home/maulik88/29_filt_samples.vcf.gz.tbi
```
In addition to the VCF input format, it is also necessary to prepare a sample map file of individuals and populations. Sample map has two tab-delimited columns: in the first column are individual IDs and in the second are population IDs as demonstrated on the example below. It is also important that the name of the file ends with ".map".
```
SRR8437780ibex	AlpineIbex
SRR8437782ibex	AlpineIbex
SRR8437783ibex	AlpineIbex
SRR8437791ibex	AlpineIbex
SRR8437793ibex	AlpineIbex
SRR8437799ibex	AlpineIbex
SRR8437809ibex	AlpineIbex
SRR8437810ibex	AlpineIbex
SRR8437811ibex	AlpineIbex
SRX5250055_SRR8442974	Appenzell
SRX5250057_SRR8442972	Appenzell
SRX5250124_SRR8442905	Appenzell
SRX5250148_SRR8442881	Appenzell
SRX5250150_SRR8442879	Appenzell
SRX5250151_SRR8442878	Appenzell
SRX5250153_SRR8442876	Appenzell
SRX5250155_SRR8442874	Appenzell
SRX5250156_SRR8442873	Appenzell
SRX5250157_SRR8442872	Appenzell
340330_T1	Bezoar
340331_T1	Bezoar
340334_T1	Bezoar
340340_T1	Bezoar
340345_T1	Bezoar
340347_T1	Bezoar
340426_T1	Bezoar
470100_T1	Bezoar
470104_T1	Bezoar
470106_T1	Bezoar
...
454948_T1	Urial
ERR454947urial	Urial
SRR12396950urial	Urial
```
For the Plink binary input, user need to specify the path to the BED/BIM/FAM files in the section of general parameters:
```input= "path/to/the/files/*.{bed,bim,fam}"```
### 2. Optional input data files
This module allows you to remove samples that you want to exclude in given analyses (```rem_indi```). You have to prepare a space/tab-delimited text file with family IDs in the first column and within-family IDs in the second column as stated by [PLINK](https://www.cog-genomics.org/plink/2.0/filter#sample) (option --remove):
```
Grigia SRX7715567_SRR11076301
Grigia SRX7715568_SRR11076300
Grigia SRX7715579_SRR11076289
```
Similarly, you can also prepare a file with the SNPs that should be removed. The appearance of the file depends on the input formats. For the VCF input, we used option ```--exclude-positions``` of [VCFtools](https://vcftools.sourceforge.net/man_latest.html), which expect a text file with a tab-separated chromosome and position of the SNP in each line:
```
NC_030835.1	1460
NC_030835.1	1498
NC_030835.1	2140
NC_030835.1	2158
NC_030835.1	2173
NC_030835.1	44663424
NC_030835.1	44663455
NC_030835.1	44664291
NC_030835.1	44664392
NC_030835.1	44664464
NC_030836.1	1510
NC_030836.1	1525
NC_030836.1	1558
NC_030836.1	1593
NC_030836.1	1595
NC_030836.1	51331074
NC_030836.1	51331096
NC_030836.1	51331185
NC_030836.1	51331237
NC_030836.1	51331522
```
### 3. Setting the parameters
At the beginning of the parameter file ***/parameters/process/general_params.config**, we have to specified some of the general things first:
```input```: path to the .csv input file for the VCF format or names of the PLINK binary files
```outDir```: the name of the output folder
```sample_map```: path to the file with the suffix ".map" that have listed individuals and populations as addition to VCF input
```concate_vcf_prefix```: file prefix of the genome-wise merged vcf files 
```geo_plot_yml```: path to the yaml file containing parameters for plotting the samples on a map 
```tile_yml```: path to the yaml file containing parameters for the geographical map to be used for plotting
``` f_pop_cord```: path to the file with geographical locations for map plotting
```f_pop_color```: path to the file with specified colors for map plotting
```fasta```: the name of the reference genome fasta file that will be used for converting in case of PLINK input
 ```allow_extra_chrom```: set to true if the input contains chromosome name in the form of string
```max_chrom```: maximum number of chromosomes
```outgroup```: the population ID of the outgroup
```cm_to_bp```: the number of base pairs that corresponds to one cM

After that, we need to change **globalfilt_params.config** according to filters we want to use.

**// general parameters**

    input                     = "test_files/test_input_vcf.csv"
    outDir                    = "${baseDir}/../Filter/"
    prefix                    = "filter"
    sample_map                = "/data/trial/sample.map"
    fasta                     = "none"
    chrm_map                  = "none"
    allow_extra_chrom         = true 
    max_chrom                 = 2
    outgroup                  = "Urial"
    cm_to_bp                   = 0

**//sample filtering parameters**

    apply_indi_filters     = true
    king_cutoff            = 0.20
    rem_indi               = "/data/trial/remove_vcf_samples.txt"
    mind                   = 0.1
    indiv_summary          = true

**//sites filtering parameters**

    apply_snp_filters      = true
    remove_snps            = "/data/trial/remove_vcf_snps.txt"
    maf                    = 0.01
    min_meanDP             = -9
    max_meanDP             = -9
    hwe                    = -9
    max_missing            = -9
    minQ                   = -9

After all the parameters are set, we can run the tool. In our case we used conda configuration profile and set maximum 10 processes that can be executed in parallel by each executor. The command looks like this:
```
nextflow run scale_popgen.nf -qs 10 -profile conda
```
You can check all the other command running options with the option help :
```
nextflow run scale_popgen.nf -help
```
After the filtering is done successfully, the command line output is looking like this:
```
N E X T F L O W  ~  version 23.04.1
Launching `scale_popgen.nf` [jolly_stone] DSL2 - revision: c7f30377b6
executor >  slurm (10)
[f3/c7400b] process > GENERATE_POP_COLOR_MAP (generating pop color map)                                  [100%] 1 of 1 ✔
[d9/c1a6d2] process > CONCAT_VCF (concate_vcf)                                                           [100%] 1 of 1 ✔
[53/b7fe9e] process > EXTRACT_UNRELATED_SAMPLE_LIST (filter_indi_goats)                                  [100%] 1 of 1 ✔
[16/35f355] process > KEEP_INDI (keep_indi_CHR29)                                                        [100%] 2 of 2 ✔
[a2/1cb2ab] process > PREPARE_NEW_MAP (preparing_new_map)                                                [100%] 1 of 1 ✔
[61/bd92b1] process > FILTER_SITES (filter_sites_CHR29)                                                  [100%] 2 of 2 ✔
[d3/bb393a] process > PREPARE_INDIV_REPORT:CALC_INDIV_SUMMARY (calculating_chromosomewise_summary_CHR29) [100%] 2 of 2 ✔
[b5/f0c4d1] process > PREPARE_INDIV_REPORT:COMBINE_INDIV_SUMMARY (combining_indiv_summary)               [100%] 1 of 1 ✔
[81/305c0e] process > PLOT_GEO_MAP (plotting_sample_on_map)                                              [100%] 1 of 1 ✔
Completed at: 07-Aug-2023 16:53:44
Duration    : 23m 5s
CPU hours   : 0.3
Succeeded   : 12
```
As you can see according to steps above, the tool will start with sample-based filtering. After that it will take the sample-filtered files and perform SNP-based filtering. We can find the final filtered files in the folder **./filter/vcftools/sites_filtered**. Based on the remaining samples this tool will also update the sample map file: **./filter/new_sample_pop.map**. 
In the general parameters we customize fields for plotting the geographic map. We can found in the output folder as **goats.html**, which can be open with the internet browser as an interactive map.





## References
Please cite the following papers if you use this sub-workflow in your study:

[1] Danecek, P., Auton, A., Abecasis, G., Albers, C. A., Banks, E., DePristo, M. A., Handsaker, R. E., Lunter, G., Marth, G. T., Sherry, S. T., McVean, G., Durbin, R., & 1000 Genomes Project Analysis Group (2011). The variant call format and VCFtools. _Bioinformatics (Oxford, England)_, _27_(15), 2156–2158. https://doi.org/10.1093/bioinformatics/btr330

[2] Purcell, S., Neale, B., Todd-Brown, K., Thomas, L., Ferreira, M. A., Bender, D., Maller, J., Sklar, P., de Bakker, P. I., Daly, M. J., & Sham, P. C. (2007). PLINK: a tool set for whole-genome association and population-based linkage analyses. _American journal of human genetics_, _81_(3), 559–575. https://doi.org/10.1086/519795
## License

MIT




## scalepopgen: TreeMix

This sub-workflow can be invoked using the argument ```treemix = true```. It consists of the following steps:

**1.** generating a file with samples and populations based on sample map provided by the user 
**2.** converting vcf to treemix input file format using python script 
**3.** merging converted treemix files (separated by chromosomes) into one 
**4.** running the treemix analysis without migration edges
**5.** running the treemix analysis with bootstraps
**6.** generating consensus tree out of the bootstrapped trees generated in the previous step
**7.** the treemix analysis with migration edges
**8.** identify optimal number of migration edges using the procedure as implemented in [OptM](https://academic.oup.com/biomethods/article/6/1/bpab017/6371180) package

> **Note:** If your input files are in Plink format, it will convert them into VCF before the first step.
## Description of the parameters:
```n_bootstrap```: number of bootstraps to be performed - if is set to 0, bootstrapping will not be performed (step 5);\
```upper_limit```: upper limit of random integer to set for different bootstrapping (step 5);\
```starting_m_value```:  the starting number of migration edges to be added to tree - if the number is set to 0, it will skip the analysis with migration edges (steps 7 and 8);\
```ending_m_value```: the maximum number of migration edges to be added to tree (steps 7 and 8);\
```n_iter```: the number of iterations to be performed for each migration edge (steps 7 and 8);\
```k_snps```: the block of SNPs to be grouped together to account for the LD in the analysis (steps 4, 5 and 7)

## Description of the output files generated by this sub-workflow:
According to different options that this tool is offering to run the TreeMix, the results will be stored in separated folders. The main folder is **\${output directory}/treemix/**, in which you will find:

->**~/input_files/**: input files for the program TreeMix\
->**~/out_tree_default_m0/**: output files from the analysis described in the step 4 above \
->**~/out_tree_bootstrap/**: output files from the analysis described in the step 5 above \
->**~/out_tree_mig/**: output files from the analysis described in the steps 7 and 8 above \
->**~/consensus_trees/**: output files from the analysis described in the step 6 above 


For workflow validation, we have downloaded publicly available samples (see map below) with whole genome sequences from NCBI database (Alberto et al., 2018; Grossen et al., 2020; Henkel et al., 2019). We included domestic goats (*Capra hircus*) represented by various breeds from Switzerland. In addition to them, we also included Alpine ibex (*C. ibex*) and Bezoar wild goat (*C. aegagrus*). Since we need an outgroup when performing some of the analyses, we also added Urial sheep (*Ovis vignei*). We will use variants from chromosome 28 and 29 of, all together, 85 animals.

		!Here will be the Geographic map picture!
Geographic map of samples used for this trial

 <font size="2">Alberto et al. (2018). Convergent genomic signatures of domestication in sheep and goats. *Nature communications*, https://doi.org/10.1038/s41467-018-03206-y \
Grossen et al. (2020). Purging of highly deleterious mutations through severe bottlenecks in Alpine ibex. *Nature communications*, https://doi.org/10.1038/s41467-020-14803-1 \
Henkel et al. (2019). Selection signatures in goats reveal copy number variants underlying breed-defining coat color phenotypes. *PLoS genetics*, https://doi.org/10.1371/journal.pgen.1008536
 </font>
### 1. Required input data files
The input data should be in the **VCF** or **PLINK binary** format files. 

All VCF files need to be splitted by the chromosomes and indexed with tabix. You will have to prepare csv list of those files, please check *test_input_vcf.csv*. Each row is corresponding to one chromosome and has three different information separated by the comma. Like in example below, the first information in each row is chromosome name, next is path/to/the/file.vcf.gz and the last is path/to/the/file.vcf.gz.tbi.  
```
chr28,https://data.cyverse.org/dav-anon/iplant/home/maulik88/28_filt_samples.vcf.gz,https://data.cyverse.org/dav-anon/iplant/home/maulik88/28_filt_samples.vcf.gz.tbi
chr29,https://data.cyverse.org/dav-anon/iplant/home/maulik88/29_filt_samples.vcf.gz,https://data.cyverse.org/dav-anon/iplant/home/maulik88/29_filt_samples.vcf.gz.tbi
```
In addition to the VCF input format, it is also necessary to prepare a sample map file of individuals and populations. Sample map has two tab-delimited columns: in the first column are individual IDs and in the second are population IDs as demonstrated on the example below. It is also important that the name of the file ends with ".map".
```
SRR8437780ibex	AlpineIbex
SRR8437782ibex	AlpineIbex
SRR8437783ibex	AlpineIbex
SRR8437791ibex	AlpineIbex
SRR8437793ibex	AlpineIbex
SRR8437799ibex	AlpineIbex
SRR8437809ibex	AlpineIbex
SRR8437810ibex	AlpineIbex
SRR8437811ibex	AlpineIbex
SRX5250055_SRR8442974	Appenzell
SRX5250057_SRR8442972	Appenzell
SRX5250124_SRR8442905	Appenzell
SRX5250148_SRR8442881	Appenzell
SRX5250150_SRR8442879	Appenzell
SRX5250151_SRR8442878	Appenzell
SRX5250153_SRR8442876	Appenzell
SRX5250155_SRR8442874	Appenzell
SRX5250156_SRR8442873	Appenzell
SRX5250157_SRR8442872	Appenzell
340330_T1	Bezoar
340331_T1	Bezoar
340334_T1	Bezoar
340340_T1	Bezoar
340345_T1	Bezoar
340347_T1	Bezoar
340426_T1	Bezoar
470100_T1	Bezoar
470104_T1	Bezoar
470106_T1	Bezoar
...
454948_T1	Urial
ERR454947urial	Urial
SRR12396950urial	Urial
```
For the Plink binary input, user need to specify the path to the BED/BIM/FAM files in the section of general parameters:
```input= "path/to/the/files/*.{bed,bim,fam}"```
### 2. Optional input data files
With this tool, we also have an option to draw a geographic map with samples' origin. For that we need to provide two files. In the first one we write down population ID in the first column and comma separated latitude and longitude in second column.
```Bezoar	32.662864436650814,51.64853259116807
Urial	34.66031157,53.49391737
AlpineIbex	46.48952713,9.832698605
ChamoisColored	46.620927266181674,7.345747305114329
Appenzell	47.33229709563813,9.401363933224248
Booted	47.426361052956736,9.384330852599533
Peacock	46.321661051197026,8.804738507288173
Toggenburg	47.358160245764715,9.01070577172017
Grigia	46.24935612558498,8.700996940189137
Saanen	46.9570926960748,8.205509946726016
```
In the second file, we will specified the hex codes of colors that will represent each population.

```AlpineIbex	#008000
Appenzell	#ff5733
Booted	#0000FF
ChamoisColored	#d6b919
Grigia	#aee716
Peacock	#16e7cc
Saanen	#75baf3
Urial	#A52A2A
Toggenburg	#da4eed
Bezoar	#FFA500
```
The last file is not obligatory as the tool can choose random colors, while the first one with coordinates is necessary for map plotting.
### 3. Setting the parameters
At the beginning we have to look into ***/parameters/process/general_params.config**, where we will specified some of the general things first:
```input```: path to the .csv input file for the VCF format or names of the PLINK binary files;\
```outDir```: the name of the output folder;\
```sample_map```: path to the file with the suffix ".map" that have listed individuals and populations as addition to VCF input;\
```concate_vcf_prefix```: file prefix of the genome-wise merged vcf files;\
```geo_plot_yml```: path to the yaml file containing parameters for plotting the samples on a map;\
```tile_yml```: path to the yaml file containing parameters for the geographical map to be used for plotting;\
``` f_pop_cord```: path to the file with geographical locations for map plotting;\
```f_pop_color```: path to the file with specified colors for map plotting;\
```fasta```: the name of the reference genome fasta file that will be used for converting in case of PLINK input;\
 ```allow_extra_chrom```: set to true if the input contains chromosome name in the form of string;\
```max_chrom```: maximum number of chromosomes;\
```outgroup```: the population ID of the outgroup;\
```cm_to_bp```: the number of base pairs that corresponds to one cM

After that, there is a file ***/parameters/process/treemix.config** dedicated to the TreeMix analysis.

**// general parameters**

    input                     = "test_files/test_input_vcf.csv"
    outDir                    = "${baseDir}/../Phylogeny/"
    sample_map                = "test_files/sample.map"
    concate_vcf_prefix        = "goats"
    geo_plot_yml              = "${baseDir}/parameters/plots/plot_sample_on_map.yml"
    tile_yml                  = "${baseDir}/parameters/plots/tiles_info.yml"
    f_pop_cord                = "test_files/geo_data.txt"
    f_pop_color               = "test_files/pop_color.txt"
    fasta                     = "none"
    chrm_map                  = "none"
    allow_extra_chrom         = true 
    max_chrom                 = 2
    outgroup                  = "Urial"
    cm_to_bp                  = 1000000

**//treemix parameters**

    treemix                   = true
    n_bootstrap               = 10
    upper_limit               = 30000
    starting_m_value          = 1
    ending_m_value            = 2
    n_iter                    = 3
    k_snps                    = 1000

When all the parameters are set, we can run the tool. In our case we used conda configuration profile and set maximum 10 processes that can be executed in parallel by each executor. After we moved to **scalepopgen** folder, we execute the following command:
```
nextflow run scalepopgen.nf -qs 10 -profile conda
```
You can check all the other command running options with the option help :
```
nextflow run scalepopgen.nf -help
```
If the module analyses are processed successfully, the command line output is looking like this:


### 4. Results
Our results are stored in output folder **/Phylogeny** and inside we have five subfolders as we run the program in different ways.



## References
Please cite the following papers if you use this sub-workflow in your study:

[1] Pickrell JK, Pritchard JK (2012) Inference of Population Splits and Mixtures from Genome-Wide Allele Frequency Data. PLOS Genetics 8(11): e1002967. https://doi.org/10.1371/journal.pgen.1002967

[2] Robert R Fitak, OptM: estimating the optimal number of migration edges on population trees using Treemix, Biology Methods and Protocols, Volume 6, Issue 1, 2021, bpab017, https://doi.org/10.1093

[3] Di Tommaso, P., Chatzou, M., Floden, E. et al. Nextflow enables reproducible computational workflows. Nat Biotechnol 35, 316-319 (2017). https://doi.org/10.1038/nbt.3820


## License

MIT





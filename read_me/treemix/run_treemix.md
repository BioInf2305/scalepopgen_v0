
## scalepopgen: TreeMix

This sub-workflow can be invoked using the argument ```treemix = true```. It consists of the following steps:
 
**1.** converting vcf to treemix input file format using python script (vcf_to_treemix.py)

**2.** merging converted treemix files (separated by chromosomes) into one 

**3.** generating a file with samples and populations based on sample map provided by the user 

**4.** running the treemix analysis without any migration edge

**5.** running the treemix analysis with 100 bootstraps

**6.** generating consensus tree out of the 100 bootstrapped trees generated in the previous step

**7.** running iterations of treemix algorithm for each migration edge (In case of 10 iterations and 10 migration edges, the program will run 10 iterations for migration edges starting from 1 to 10.)

**8.** identify optimal migration edges using the procedure as implemented in [OptM](https://academic.oup.com/biomethods/article/6/1/bpab017/6371180) package

> **Note:** If your input files are in Plink format, it will convert them into VCF before the first step.
## Description of the parameters:
```n_bootstrap```: number of bootstrapping to be performed (default: 100); if the number is set to 0, bootstraping will not be performed;
```upper_limit```: the number of bootstrapping to be performed (default: 100);
```starting_m_value```:  the starting value of migration edges to be added (default: 1); if the number is set to 0, it will skip the steps of adding migration edges (steps 7 and 8);
```ending_m_value```: the ending value of migration edges to be added (default: 10);
```n_iter```: the number of iterations to be performed for each migration edge (default: 10);
```k_snps```: the block of SNPs to be grouped together to account for the LD (default: 500);


## Description of the output files generated by this sub-workflow:
If the pipeline has completed successfully, all these output files will be stored in **\${output directory}/treemix/**:
**\*_treemix_input.gz** : merged input file used for the treemix analysis (step 2)
**\*_default_mig0\_\*** : output files from the treemix analysis described in the step 4 above. 
**\*_bootstrap_iter_\${randit}\_*** : output files from the treemix analysis described in step 5 above; "randit" refers to the random seed set for each bootstrapping
**treefile** and **treeout** : consensus tree info produced after bootstrapping (step 6)
**\*_default\_${it}\_m\${mig}\_\*** : output files from the treemix analysis described in the step 7; the variable "it" refers to the number of iteration and "mig" refers to the number of migration edges considered. 
**\*_optm_out.pdf** : output files from the program Optm as described in the step 8 above

> **Note:** The output folder also contains the pdf files of output tree and residual matrix of each treemix run. 

## Validation of the sub-workflow:
### 1. Required input data files

For workflow validation, we have downloaded publicly available samples with whole genome sequences from NCBI database. We included domestic goats (*Capra hircus*) represented by various breeds from Morocco and Switzerland (geo_map). In addition to them, we also included some wild *Capra* members that are: Alpine ibex (*C. ibex*), Iberian ibex (*C. pyrenaica*) and Siberian ibex (*C. sibirica*). Since we need an outgroup when performing some analyses, we also added Urial sheep (*Ovis vignei*). We will use variants from chromosome 28 and 29 of, all together, 39 animals.

The input data should be in the **VCF** or **PLINK binary** format files. 

All VCF files need to be splitted by the chromosomes and indexed with tabix. You will have to prepare csv list of those files. Each row is corresponding to one chromosome and each row has three different information separated by the comma. Like in example below, the first information in each row is chromosome name, next is path/to/the/file.vcf.gz and the last is path/to/the/file.vcf.gz.tbi.  
```
Chr28,/data/trial/NC_030835.1.vcf.gz,/data/trial/NC_030835.1.vcf.gz.tbi
Chr29,/data/trial/NC_030836.1.vcf.gz,/data/trial/NC_030836.1.vcf.gz.tbi
```
In addition to the VCF input format, it is also necessary to prepare a sample map file of individuals and populations. Sample map has two tab-delimited columns: in the first column are individual IDs and in the second are population IDs as demonstrated on the example below.
```
AfrGoat10 AfricaGoat
AfrGoat1 AfricaGoat
AfrGoat2 AfricaGoat
AfrGoat3 AfricaGoat
AfrGoat4 AfricaGoat
AfrGoat5 AfricaGoat
AfrGoat6 AfricaGoat
AfrGoat7 AfricaGoat
AfrGoat8 AfricaGoat
AfrGoat9 AfricaGoat
AlpIbex1 AlpineIbex
AlpIbex2 AlpineIbex
AlpIbex3 AlpineIbex
AlpIbex4 AlpineIbex
AlpIbex5 AlpineIbex
AlpIbex6 AlpineIbex
AlpIbex7 AlpineIbex
AlpIbex8 AlpineIbex
AlpIbex9 AlpineIbex
IbrIbex1 IberianIbex
IbrIbex2 IberianIbex
IbrIbex3 IberianIbex
IbrIbex4 IberianIbex
SibIbex1 SiberianIbex
SibIbex2 SiberianIbex
SwiGoat10 SwissGoat
SwiGoat11 SwissGoat
SwiGoat12 SwissGoat
SwiGoat1 SwissGoat
SwiGoat2 SwissGoat
SwiGoat3 SwissGoat
SwiGoat4 SwissGoat
SwiGoat5 SwissGoat
SwiGoat6 SwissGoat
SwiGoat7 SwissGoat
SwiGoat8 SwissGoat
SwiGoat9 SwissGoat
UriShep1 Urial
UriShep2 Urial
```
For the Plink binary input, you need to specified the path to the BED/BIM/FAM files in the section of general parameters:
```input= "path/to/the/files/*.{bed,bim,fam}"```
### 2. Setting the parameters
At the beginning of the parameter file ***/parameters/scale_popgen.config**, we have to specified some of the general things first. 
```input```: name of the .csv input file for the VCF format or names of the PLINK binary files
```outDir```: the name of the output folder
```prefix```: prefix of the output files
```sample_map```: the name of the file with individuals and populations as addition to VCF input
```fasta```: the name of the reference genome fasta file that will be used for converting from VCF to PLINK format 
 ```allow_extra_chrom```: set to true if the input contains chromosome name in the form of string
```max_chrom```: maximum number of chromosomes
```outgroup```: the population ID of the outgroup (optimal)
```cm_to_bp```: the number of base pairs that corresponds to one centimorgan (optimal)

After that, there are two parts dedicated to the TreeMix analysis.

**// general parameters**

    input                     = "/data/trial/input.csv"
    outDir                    = "${baseDir}/../TreeMix/"
    prefix                    = "TreeMix"
    sample_map                = "/data/trial/sample.map"
    fasta                     = "/data/trial/goat_ref.fasta"
    chrm_map                  = "none"
    allow_extra_chrom         = true 
    max_chrom                 = 2
    outgroup                  = "Urial"
    cm_to_bp                   = 0

**//treemix analysis parameters**

    treemix                   = true
    n_bootstrap               = 10
    upper_limit               = 600
    starting_m_value          = 1
    ending_m_value            = 5
    n_iter                    = 10
    k_snps                    = 5000

## References
Please cite the following papers if you use this sub-workflow in your study:

[1] Pickrell JK, Pritchard JK (2012) Inference of Population Splits and Mixtures from Genome-Wide Allele Frequency Data. PLOS Genetics 8(11): e1002967. https://doi.org/10.1371/journal.pgen.1002967
[2] Robert R Fitak, OptM: estimating the optimal number of migration edges on population trees using Treemix, Biology Methods and Protocols, Volume 6, Issue 1, 2021, bpab017, https://doi.org/10.1093
[3] Di Tommaso, P., Chatzou, M., Floden, E. et al. Nextflow enables reproducible computational workflows. Nat Biotechnol 35, 316â€“319 (2017). https://doi.org/10.1038/nbt.3820
[4] Upadhyay M., Pogorevc N., Medugorac I. (2023). scalepopgen: a bioinformatics workflow resources implemented in Nextflow for population genomic analyses. XXXXXXXXXXXXX


## License

MIT




